# tile-gl

![tests](https://github.com/GlobeletJS/tile-gl/actions/workflows/node.js.yml/badge.svg)

Data serializers and WebGL renderers for tiled vector map layers

tile-gl exposes two methods:
- initSerializer: Initialize a geometry serializer, to parse GeoJSON
  features into buffers that can be read by tile-gl renderers
- initGLpaint: Wrap a WebGL context with methods to load the buffers to the
  GPU, and to construct renderers for [MapLibre style layers][MapLibre]

See a simple [example][] of tile-gl rendering vector tile data following a
style from [OpenMapTiles][]

[MapLibre]: https://maplibre.org/maplibre-gl-js-docs/style-spec/layers/
[example]: https://globeletjs.github.io/tile-gl/examples/maptiler-basic/index.html
[OpenMapTiles]: https://openmaptiles.org/styles/

## initSerializer
Initializes a geometry serializer, to parse GeoJSON features into buffers
that can be read by tile-gl renderers

### Syntax
```javascript
import * as tileGL from "tile-gl";

const serializer = tileGL.initSerializer(style);
```

where the argument is a layer from a [MapLibre style document][MapLibre], 
as parsed by the `getStyleFuncs` method from [tile-stencil][].

### API
The functionality of the returned serializer depends on the type of the
supplied style
- `circle`: Inputs Point or MultiPoint geometries, and creates the buffers
  needed to render circle styles
- `line`: Inputs LineString, MultiLineString, Polygon, or MultiPolygon
  geometries, and creates the buffers needed to render line styles
- `fill`: Inputs Polygon or MultiPolygon geometries, and creates the buffers
  needed to render fill styles
- `symbol`: Inputs Point features, and creates the buffers needed to render
  text labels, as generated by [tile-labeler][]

[tile-labeler]: https://github.com/GlobeletJS/tile-labeler
[tile-stencil]: https://github.com/GlobeletJS/tile-stencil

## initGLpaint
Wraps a WebGL contexts with methods to load buffers to the GPU, and to
construct renderers for [MapLibre style layers][MapLibre]

### Syntax
```javascript
import * as tileGL from "tile-gl";

const context = tileGL.initGLpaint(parameters);
```

where the supplied parameters object has the following properties:
- `.context` (REQUIRED): A WebGL context wrapper, as created by the
  [yawgl][] method `initContext`
- `.framebuffer`: A framebuffer object, as created by `context.initFramebuffer`,
  on which draw calls will be executed. If null, draw calls will render
  directly to `context.gl.canvas`
- `.projScale`: A Boolean flag indicating whether to scale style dimensions
  by the ratio of the projection scale at the given feature, vs the supplied
  scalar (e.g., the projection scale at the camera position). Default: false
- `.multiTile`: A Boolean flag indicating whether painter programs (initialized
  by the `.initPainter` method) will input multi-tile tilesets. Default: true.
  Set to false to initialize single-tile painters
 
[yawgl]: https://github.com/GlobeletJS/yawgl

### API
The returned context object exposes the following methods:
- `.prep()`: Calls `context.bindFramebufferAndSetViewport` and `context.clear`,
  as prep for a draw call
- `.loadBuffers(buffers)`: Loads the supplied buffers
- `.loadAtlas(atlas)`: Loads a supplied atlas image object, as generated by
  [tile-labeler][]
- `.initPainter(style)`: Initializes a painter program for the given style
  layer. Note: the style layer must have been parsed by [tile-stencil][]

### Signature of painter functions
The painter functions returned by the `.initPainter` method have the following
signature:
```javascript
const painter = context.initPainter(style);

painter(parameters);
```

where the `parameters` object has the following properties:
`{ tile OR tileset, zoom, pixRatio, cameraScale }`.
- `tile` (IF the context was initialized with `multiTile: false`): 
  The tile to be rendered. The tile object must have the following properties:
  - `z, x, y`: The coordinate indices of the tile
  - `data`: A data object with the same structure as returned by [tile-mixer][],
    with the `.atlas` processed by the tile-gl context's `.loadAtlas` method,
    and the layer `.buffers` properties processed by `.loadBuffers`
- `tileset` (IF the context was initialized with `multiTile: true`):
  An array of tileboxes. The array has global properties `{ translate, scale }`,
  which can be used to compute the position of each tile within a viewport. See
  [d3-tile][] for details. Each tilebox element in the array has the following 
  properties:
  - `z, x, y`: The coordinates of the map tile to be rendered using this tile's
    data (may be different from the native coordinates of the tile)
  - `tile`: A tile object with properties `{ z, x, y, data }`, as described
    above for single-tile rendering
- `zoom`: The zoom level to be used for setting zoom-dependent styles
- `pixRatio`: The ratio between Canvas pixel dimensions and map style
  dimensions. This should usually be set to [window.devicePixelRatio][].
  Default: 1.0
- `cameraScale`: The projection scale at the camera position. Used for scaling
  style dimensions by relative projection scales, IF the context was initialized
  with `projScale: true`. Default: 1.0

[tile-mixer]: https://github.com/GlobeletJS/tile-mixer
[d3-tile]: https://github.com/d3/d3-tile
[window.devicePixelRatio]: https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio
